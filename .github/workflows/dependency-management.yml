name: Dependency Management

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Update type'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major
        - all

permissions:
  contents: write
  pull-requests: write
  security-events: write

jobs:
  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run npm audit
        run: |
          echo "ðŸ” Running security audit..."
          npm audit --audit-level info --json > audit-report.json || true
          
          # Parse audit results
          node -e "
            const fs = require('fs');
            const audit = JSON.parse(fs.readFileSync('audit-report.json', 'utf8'));
            
            console.log('ðŸ“Š Audit Summary:');
            console.log('================');
            console.log(\`Total vulnerabilities: \${audit.metadata?.vulnerabilities?.total || 0}\`);
            console.log(\`Critical: \${audit.metadata?.vulnerabilities?.critical || 0}\`);
            console.log(\`High: \${audit.metadata?.vulnerabilities?.high || 0}\`);
            console.log(\`Moderate: \${audit.metadata?.vulnerabilities?.moderate || 0}\`);
            console.log(\`Low: \${audit.metadata?.vulnerabilities?.low || 0}\`);
            console.log(\`Info: \${audit.metadata?.vulnerabilities?.info || 0}\`);
            
            if (audit.metadata?.vulnerabilities?.critical > 0 || audit.metadata?.vulnerabilities?.high > 0) {
              console.log('âš ï¸ Critical or high severity vulnerabilities found!');
              process.exit(1);
            } else {
              console.log('âœ… No critical or high severity vulnerabilities found');
            }
          "
          
      - name: Check for outdated dependencies
        run: |
          echo "ðŸ“¦ Checking for outdated dependencies..."
          npm outdated --json > outdated-report.json || true
          
          node -e "
            const fs = require('fs');
            let outdated = {};
            try {
              outdated = JSON.parse(fs.readFileSync('outdated-report.json', 'utf8'));
            } catch (e) {
              console.log('No outdated dependencies found');
              process.exit(0);
            }
            
            const deps = Object.keys(outdated);
            if (deps.length === 0) {
              console.log('âœ… All dependencies are up to date');
            } else {
              console.log(\`ðŸ“‹ Found \${deps.length} outdated dependencies:\`);
              deps.forEach(dep => {
                const info = outdated[dep];
                console.log(\`  - \${dep}: \${info.current} â†’ \${info.latest}\`);
              });
            }
          "
          
      - name: License compliance check
        run: |
          echo "âš–ï¸ Checking license compliance..."
          npx license-checker --onlyAllow 'MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;Unlicense;WTFPL' --json > license-report.json || true
          
          node -e "
            const fs = require('fs');
            try {
              const licenses = JSON.parse(fs.readFileSync('license-report.json', 'utf8'));
              const packages = Object.keys(licenses);
              console.log(\`âœ… License compliance check passed for \${packages.length} packages\`);
              
              // Group by license type
              const licenseGroups = {};
              Object.values(licenses).forEach(pkg => {
                const license = pkg.licenses || 'Unknown';
                licenseGroups[license] = (licenseGroups[license] || 0) + 1;
              });
              
              console.log('ðŸ“„ License distribution:');
              Object.entries(licenseGroups)
                .sort(([,a], [,b]) => b - a)
                .forEach(([license, count]) => {
                  console.log(\`  - \${license}: \${count} packages\`);
                });
            } catch (e) {
              console.log('âŒ License compliance check failed:', e.message);
              process.exit(1);
            }
          "
          
      - name: Upload audit reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-reports
          path: |
            audit-report.json
            outdated-report.json
            license-report.json
          retention-days: 30

  dependency-update:
    name: Dependency Update
    runs-on: ubuntu-latest
    needs: [dependency-audit]
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
      - name: Update dependencies
        run: |
          echo "ðŸ”„ Updating dependencies..."
          
          UPDATE_TYPE="${{ github.event.inputs.update_type || 'patch' }}"
          
          case $UPDATE_TYPE in
            "patch")
              echo "Updating patch versions only..."
              npx npm-check-updates --target patch --upgrade
              ;;
            "minor")
              echo "Updating minor versions..."
              npx npm-check-updates --target minor --upgrade
              ;;
            "major")
              echo "Updating major versions (careful!)..."
              npx npm-check-updates --target major --upgrade
              ;;
            "all")
              echo "Updating all dependencies to latest..."
              npx npm-check-updates --upgrade
              ;;
          esac
          
      - name: Install updated dependencies
        run: |
          npm install
          npm audit fix --audit-level moderate || true
          
      - name: Run tests after update
        run: |
          npm run build
          npm run test:coverage
          npm run lint
          
      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet package.json package-lock.json; then
            echo "No dependency updates available"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Dependencies updated"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # Generate update summary
            git diff package.json | grep -E '^\+.*".*":' | head -20 > updated_deps.txt || echo "No direct dependency changes" > updated_deps.txt
          fi
          
      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update dependencies (${{ github.event.inputs.update_type || 'patch' }})"
          title: "ðŸ”„ Dependency Update (${{ github.event.inputs.update_type || 'patch' }})"
          body: |
            ## Dependency Update
            
            This PR updates dependencies to their latest ${{ github.event.inputs.update_type || 'patch' }} versions.
            
            ### Changes
            - Update type: **${{ github.event.inputs.update_type || 'patch' }}**
            - Updated by: GitHub Actions
            - Timestamp: ${{ github.run_id }}
            
            ### Testing
            - âœ… Build successful
            - âœ… Tests passing
            - âœ… Linting passed
            - âœ… Security audit clean
            
            ### Review Notes
            Please review the changes carefully, especially for major version updates.
            
            Auto-merge is **disabled** - manual review required.
          branch: dependency-updates/${{ github.run_id }}
          delete-branch: true
          reviewers: ${{ github.actor }}
          labels: |
            dependencies
            automated
            ${{ github.event.inputs.update_type || 'patch' }}

  vulnerability-scan:
    name: Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run Snyk vulnerability scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=medium --json-file-output=snyk-report.json
        continue-on-error: true
        
      - name: Run OSV vulnerability scan
        run: |
          echo "ðŸ” Running OSV vulnerability scan..."
          npx osv-scanner --format json --output osv-report.json package-lock.json || true
          
      - name: Generate vulnerability summary
        run: |
          echo "ðŸ“Š Vulnerability Summary"
          echo "======================="
          
          # Snyk summary
          if [ -f "snyk-report.json" ]; then
            echo "Snyk scan completed - check artifacts for details"
          else
            echo "Snyk scan not available (token may be missing)"
          fi
          
          # OSV summary
          if [ -f "osv-report.json" ]; then
            node -e "
              const fs = require('fs');
              try {
                const osv = JSON.parse(fs.readFileSync('osv-report.json', 'utf8'));
                const vulns = osv.results?.[0]?.packages?.[0]?.vulnerabilities || [];
                console.log(\`OSV found \${vulns.length} vulnerabilities\`);
                if (vulns.length > 0) {
                  console.log('Top vulnerabilities:');
                  vulns.slice(0, 5).forEach(v => {
                    console.log(\`  - \${v.id}: \${v.summary || 'No summary'}\`);
                  });
                }
              } catch (e) {
                console.log('OSV report parsing failed');
              }
            "
          else
            echo "OSV scan completed with no issues"
          fi
          
      - name: Upload vulnerability reports
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-reports
          path: |
            snyk-report.json
            osv-report.json
          retention-days: 30
          
      - name: Create security advisory PR
        if: failure()
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "security: address vulnerability findings"
          title: "ðŸš¨ Security Advisory - Vulnerability Fixes Required"
          body: |
            ## Security Advisory
            
            High-priority vulnerabilities detected in dependencies.
            
            ### Action Required
            - Review vulnerability reports in workflow artifacts
            - Update affected dependencies
            - Test thoroughly before merging
            
            ### Reports
            - Snyk scan results available in artifacts
            - OSV scan results available in artifacts
            
            **Priority: HIGH** - Address immediately
          branch: security-fixes/${{ github.run_id }}
          labels: |
            security
            vulnerability
            high-priority 