name: Quality Gates

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run weekly quality analysis on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'

permissions:
  contents: read
  pull-requests: write
  checks: write
  security-events: write

jobs:
  code-analysis:
    name: Static Code Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run ESLint with detailed reporting
        run: |
          echo "ðŸ” Running ESLint analysis..."
          npx eslint src tests --ext .ts,.js --format json --output-file eslint-report.json || true
          npx eslint src tests --ext .ts,.js --format unix > eslint-unix.txt || true
          
          # Generate summary
          node -e "
            const fs = require('fs');
            try {
              const report = JSON.parse(fs.readFileSync('eslint-report.json', 'utf8'));
              const totalFiles = report.length;
              const filesWithErrors = report.filter(f => f.errorCount > 0).length;
              const filesWithWarnings = report.filter(f => f.warningCount > 0).length;
              const totalErrors = report.reduce((sum, f) => sum + f.errorCount, 0);
              const totalWarnings = report.reduce((sum, f) => sum + f.warningCount, 0);
              
              console.log('ðŸ“Š ESLint Summary:');
              console.log('=================');
              console.log(\`Files analyzed: \${totalFiles}\`);
              console.log(\`Files with errors: \${filesWithErrors}\`);
              console.log(\`Files with warnings: \${filesWithWarnings}\`);
              console.log(\`Total errors: \${totalErrors}\`);
              console.log(\`Total warnings: \${totalWarnings}\`);
              
              if (totalErrors > 0) {
                console.log('\\nâŒ ESLint found errors - review required');
                process.exit(1);
              } else {
                console.log('\\nâœ… ESLint analysis passed');
              }
            } catch (e) {
              console.log('âŒ Failed to parse ESLint report');
              process.exit(1);
            }
          "
          
      - name: TypeScript strict checks
        run: |
          echo "ðŸ”§ Running TypeScript strict analysis..."
          
          # Create strict tsconfig for analysis
          cat > tsconfig.strict.json << EOF
          {
            "extends": "./tsconfig.json",
            "compilerOptions": {
              "strict": true,
              "noImplicitAny": true,
              "strictNullChecks": true,
              "strictFunctionTypes": true,
              "strictBindCallApply": true,
              "strictPropertyInitialization": true,
              "noImplicitReturns": true,
              "noFallthroughCasesInSwitch": true,
              "noUncheckedIndexedAccess": true,
              "noImplicitOverride": true,
              "exactOptionalPropertyTypes": true
            }
          }
          EOF
          
          npx tsc --project tsconfig.strict.json --noEmit --pretty false > typescript-strict.log 2>&1 || true
          
          if [ -s typescript-strict.log ]; then
            echo "âš ï¸ TypeScript strict mode issues found:"
            head -20 typescript-strict.log
            echo "... (see full log in artifacts)"
          else
            echo "âœ… TypeScript strict mode checks passed"
          fi
          
      - name: Complexity analysis
        run: |
          echo "ðŸ“Š Running complexity analysis..."
          
          # Install complexity tools
          npm install -g @es-kit/typescript-complexity plato
          
          # Analyze TypeScript complexity
          npx typescript-complexity src --output complexity-report.json || true
          
          # Generate complexity summary
          if [ -f "complexity-report.json" ]; then
            node -e "
              const fs = require('fs');
              try {
                const report = JSON.parse(fs.readFileSync('complexity-report.json', 'utf8'));
                console.log('ðŸ“ˆ Complexity Analysis:');
                console.log('=====================');
                
                if (report.files && Array.isArray(report.files)) {
                  const complexFiles = report.files.filter(f => f.complexity > 10);
                  console.log(\`Files analyzed: \${report.files.length}\`);
                  console.log(\`High complexity files (>10): \${complexFiles.length}\`);
                  
                  if (complexFiles.length > 0) {
                    console.log('\\nHigh complexity files:');
                    complexFiles.slice(0, 5).forEach(f => {
                      console.log(\`  - \${f.path}: \${f.complexity}\`);
                    });
                  }
                } else {
                  console.log('No complexity data available');
                }
              } catch (e) {
                console.log('No complexity report available');
              }
            "
          fi
          
      - name: Dead code detection
        run: |
          echo "ðŸ§¹ Detecting dead code..."
          
          npx ts-unused-exports tsconfig.json > unused-exports.txt || true
          
          if [ -s unused-exports.txt ]; then
            echo "âš ï¸ Unused exports detected:"
            head -10 unused-exports.txt
            echo "... (see full report in artifacts)"
          else
            echo "âœ… No unused exports found"
          fi
          
      - name: Bundle analysis
        run: |
          echo "ðŸ“¦ Analyzing bundle..."
          
          npm run build
          
          # Analyze bundle size
          find dist -name "*.js" -exec wc -c {} + | sort -nr > bundle-sizes.txt
          
          echo "ðŸ“Š Bundle Analysis:"
          echo "=================="
          echo "Total bundle size:"
          du -sh dist/
          echo ""
          echo "Largest files:"
          head -5 bundle-sizes.txt
          
      - name: Upload analysis artifacts
        uses: actions/upload-artifact@v4
        with:
          name: code-analysis
          path: |
            eslint-report.json
            eslint-unix.txt
            typescript-strict.log
            complexity-report.json
            unused-exports.txt
            bundle-sizes.txt
          retention-days: 30

  sonarqube-analysis:
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    needs: [code-analysis]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run tests with coverage
        run: npm run test:coverage:lcov
        
      - name: SonarQube Scan
        uses: sonarqube-action@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=${{ github.repository }}
            -Dsonar.organization=${{ github.repository_owner }}
            -Dsonar.host.url=https://sonarcloud.io
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.typescript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.coverage.exclusions=tests/**,scripts/**,**/*.test.ts,**/*.spec.ts
            -Dsonar.cpd.exclusions=tests/**,scripts/**
            -Dsonar.sources=src
            -Dsonar.tests=tests
            -Dsonar.test.inclusions=tests/**/*.test.ts,tests/**/*.spec.ts
            
      - name: Quality Gate Check
        uses: sonarqube-quality-gate-action@master
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  security-analysis:
    name: Security Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
          queries: security-and-quality
          
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        
      - name: Run Semgrep security scan
        uses: semgrep/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/nodejs
            p/typescript
            p/owasp-top-ten
          
      - name: Upload Semgrep results to GitHub
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep.sarif
          
      - name: Bandit security linter (if Python files exist)
        run: |
          if find . -name "*.py" -type f | head -1 | grep -q .; then
            echo "ðŸ Python files detected, running Bandit..."
            pip install bandit
            bandit -r . -f json -o bandit-report.json || true
          else
            echo "No Python files found, skipping Bandit"
          fi
          
      - name: Upload security artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-analysis
          path: |
            semgrep.sarif
            bandit-report.json
          retention-days: 30

  performance-analysis:
    name: Performance Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build project
        run: npm run build
        
      - name: Performance benchmarks
        run: |
          echo "âš¡ Running performance analysis..."
          
          # Run comprehensive benchmarks
          npm run bench
          npm run bench:tools
          npm run bench:transports
          
          # Analyze results
          node -e "
            const fs = require('fs');
            try {
              const mainResults = JSON.parse(fs.readFileSync('benchmark-results.json', 'utf8'));
              const toolResults = JSON.parse(fs.readFileSync('tool-benchmark-results.json', 'utf8'));
              const transportResults = JSON.parse(fs.readFileSync('transport-benchmark-results.json', 'utf8'));
              
              const normalizeResults = (results) => Array.isArray(results) ? results : (results.results || []);
              const allResults = [
                ...normalizeResults(mainResults),
                ...normalizeResults(toolResults),
                ...normalizeResults(transportResults)
              ];
              
              console.log('âš¡ Performance Summary:');
              console.log('=====================');
              console.log(\`Total benchmarks: \${allResults.length}\`);
              
              // Performance classification
              const fast = allResults.filter(r => (r.ops || r.value) >= 1000000);
              const medium = allResults.filter(r => (r.ops || r.value) >= 100000 && (r.ops || r.value) < 1000000);
              const slow = allResults.filter(r => (r.ops || r.value) < 100000);
              
              console.log(\`Fast operations (â‰¥1M ops/sec): \${fast.length}\`);
              console.log(\`Medium operations (100K-1M ops/sec): \${medium.length}\`);
              console.log(\`Slow operations (<100K ops/sec): \${slow.length}\`);
              
              if (slow.length > allResults.length * 0.3) {
                console.log('\\nâš ï¸ High percentage of slow operations detected');
              } else {
                console.log('\\nâœ… Performance within acceptable ranges');
              }
              
              // Top 5 fastest operations
              const sorted = allResults.sort((a, b) => (b.ops || b.value) - (a.ops || a.value));
              console.log('\\nðŸš€ Top 5 fastest operations:');
              sorted.slice(0, 5).forEach((op, i) => {
                const opsValue = op.ops || op.value || 0;
                console.log(\`  \${i+1}. \${op.name}: \${opsValue.toLocaleString()} ops/sec\`);
              });
              
            } catch (e) {
              console.log('âŒ Failed to analyze performance results');
            }
          "
          
      - name: Memory usage analysis
        run: |
          echo "ðŸ§  Analyzing memory usage..."
          npm run perf:enhanced > memory-analysis.log 2>&1 || true
          
          if [ -f "memory-analysis.log" ]; then
            echo "Memory analysis completed - check artifacts for details"
            tail -20 memory-analysis.log
          fi
          
      - name: Upload performance artifacts
        uses: actions/upload-artifact@v4
        with:
          name: performance-analysis
          path: |
            benchmark-results.json
            tool-benchmark-results.json
            transport-benchmark-results.json
            memory-analysis.log
          retention-days: 30

  quality-summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [code-analysis, security-analysis, performance-analysis]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        
      - name: Generate quality report
        run: |
          echo "ðŸ“Š Quality Gates Summary" > quality-report.md
          echo "======================" >> quality-report.md
          echo "" >> quality-report.md
          echo "**Generated**: $(date -u)" >> quality-report.md
          echo "**Commit**: ${{ github.sha }}" >> quality-report.md
          echo "**Branch**: ${{ github.ref_name }}" >> quality-report.md
          echo "" >> quality-report.md
          
          # Job status summary
          echo "## Job Status" >> quality-report.md
          echo "| Job | Status |" >> quality-report.md
          echo "|-----|--------|" >> quality-report.md
          echo "| Code Analysis | ${{ needs.code-analysis.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> quality-report.md
          echo "| Security Analysis | ${{ needs.security-analysis.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> quality-report.md
          echo "| Performance Analysis | ${{ needs.performance-analysis.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> quality-report.md
          echo "" >> quality-report.md
          
          # Overall status
          OVERALL_STATUS="PASSED"
          if [ "${{ needs.code-analysis.result }}" != "success" ] || \
             [ "${{ needs.security-analysis.result }}" != "success" ] || \
             [ "${{ needs.performance-analysis.result }}" != "success" ]; then
            OVERALL_STATUS="FAILED"
          fi
          
          echo "## Overall Status: $OVERALL_STATUS" >> quality-report.md
          echo "" >> quality-report.md
          
          if [ "$OVERALL_STATUS" = "FAILED" ]; then
            echo "âš ï¸ **One or more quality gates failed. Review the detailed reports in workflow artifacts.**" >> quality-report.md
          else
            echo "âœ… **All quality gates passed successfully!**" >> quality-report.md
          fi
          
          echo "" >> quality-report.md
          echo "## Available Reports" >> quality-report.md
          echo "- Code Analysis (ESLint, TypeScript, Complexity)" >> quality-report.md
          echo "- Security Analysis (CodeQL, Semgrep)" >> quality-report.md
          echo "- Performance Analysis (Benchmarks, Memory)" >> quality-report.md
          echo "" >> quality-report.md
          echo "Download artifacts from this workflow run for detailed reports." >> quality-report.md
          
      - name: Comment PR with quality summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('quality-report.md', 'utf8');
            
            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingComment = comments.data.find(
              comment => comment.body.includes('Quality Gates Summary')
            );
            
            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: report
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report
              });
            }
            
      - name: Upload quality summary
        uses: actions/upload-artifact@v4
        with:
          name: quality-summary
          path: quality-report.md
          retention-days: 90